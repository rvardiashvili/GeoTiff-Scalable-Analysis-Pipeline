<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BigEarthNet v2.0 Viewer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f9f9f9; color: #333; }
        h1, h2 { color: #111; }
        #report table { border-collapse: collapse; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #report th, #report td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        #report th { background-color: #f2f2f2; font-weight: 600; }
        #report tr:nth-child(even) { background-color: #fdfdfd; }
        #report tr:hover { background-color: #f1f1f1; }
        .tile { background-color: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 1.5em; margin-bottom: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tile img { max-width: 100%; border-radius: 4px; }
        .legend { columns: 2; -webkit-columns: 2; -moz-columns: 2; margin-top: 1em; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; }
        .legend-color { width: 20px; height: 20px; margin-right: 10px; border: 1px solid #000; border-radius: 4px; }
        #file-picker { margin-bottom: 2em; }
    </style>
</head>
<body>
    <h1>BigEarthNet v2.0 Analysis Viewer</h1>

    <div id="file-picker">
        <label for="directory-picker">Select Output Directory:</label>
        <input type="file" id="directory-picker" webkitdirectory directory>
    </div>

    <h2>Benchmark Report</h2>
    <div id="report">Select a directory to view the report.</div>

    <h2>Analyzed Tiles</h2>
    <div id="tiles"></div>

    <script>
        document.getElementById('directory-picker').addEventListener('change', handleDirectorySelect);

        function handleDirectorySelect(event) {
            const files = event.target.files;
            const fileList = Array.from(files);

            // Clear previous content
            document.getElementById('report').innerHTML = 'Loading report...';
            document.getElementById('tiles').innerHTML = '';

            // Find and process benchmark report
            const reportFile = fileList.find(f => f.name === 'benchmark_report.csv');
            if (reportFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    const rows = data.trim().split('\n').map(row => row.split(','));
                    if (rows.length < 1) return;
                    let table = '<table>';
                    table += '<thead><tr>' + rows[0].map(header => `<th>${header}</th>`).join('') + '</tr></thead>';
                    table += '<tbody>';
                    for (let i = 1; i < rows.length; i++) {
                        if (rows[i].length === rows[0].length) {
                            table += '<tr>' + rows[i].map(cell => `<td>${cell}</td>`).join('') + '</tr>';
                        }
                    }
                    table += '</tbody></table>';
                    document.getElementById('report').innerHTML = table;
                };
                reader.readAsText(reportFile);
            } else {
                document.getElementById('report').innerHTML = '<p>benchmark_report.csv not found in the selected directory.</p>';
            }

            // Find and process tiles
            const tileDirs = new Set(fileList.map(f => {
                const parts = f.webkitRelativePath.split('/');
                if (parts.length > 2) {
                    return parts[1];
                }
                return null;
            }).filter(Boolean));

            const tilesContainer = document.getElementById('tiles');
            if (tileDirs.size === 0) {
                tilesContainer.innerHTML = '<p>No analyzed tiles found.</p>';
            } else {
                tileDirs.forEach(dir => {
                    const tileElement = document.createElement('div');
                    tileElement.className = 'tile';
                    tileElement.innerHTML = `<h3>${dir}</h3>`;

                    // Find and display preview image
                    const previewFile = fileList.find(f => f.webkitRelativePath.endsWith(`${dir}/preview.png`));
                    if (previewFile) {
                        const previewImg = document.createElement('img');
                        previewImg.src = URL.createObjectURL(previewFile);
                        previewImg.alt = `Preview for ${dir}`;
                        tileElement.appendChild(previewImg);
                    }

                    // Find and display legend
                    const classmapFile = fileList.find(f => f.webkitRelativePath.endsWith(`${dir}/${dir}_classmap.json`));
                    if (classmapFile) {
                        const legendElement = document.createElement('div');
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const classmap = JSON.parse(e.target.result);
                                let legendHtml = '<h4>Legend</h4><div class="legend">';
                                for (const label in classmap) {
                                    if (label !== 'No_Dominant_Class' && classmap[label].color_rgb) {
                                        const color = classmap[label].color_rgb;
                                        legendHtml += "\n            <div class=\"legend-item\">
                <div class=\"legend-color\" style=\"background-color: rgb(" + color[0] + ", " + color[1] + ", " + color[2] + ")"></div>
                <span>" + label.replace(/_/g, ' ') + "</span>
            </div>";
                                    }
                                }
                                legendHtml += '</div>';
                                legendElement.innerHTML = legendHtml;
                            } catch (error) {
                                legendElement.innerHTML = `<p>Error parsing classmap.json for ${dir}: ${error.message}</p>`;
                            }
                        };
                        reader.readAsText(classmapFile);
                        tileElement.appendChild(legendElement);
                    }
                    tilesContainer.appendChild(tileElement);
                });
            }
        }
    </script>
</body>
</html>
